import * as fs from 'fs'
import * as path from 'path'
import { fileURLToPath } from 'url'

const TEMPLATE_FILE_NAME = '.env.template'
const OUTPUT_FILE_NAME = 'env.generated.ts'
const __filename = fileURLToPath(import.meta.url)

function generateEnvTypes() {
  const targetAppPath = process.argv[2]

  if (!targetAppPath) {
    console.error(
      'Error: Target application path (e.g., ./apps/api) must be provided as an argument.'
    )
    process.exit(1)
  }

  const templatePath = path.join(targetAppPath, TEMPLATE_FILE_NAME)

  const OUTPUT_DIR = path.join(targetAppPath, 'src/constants')
  const OUTPUT_PATH = path.join(OUTPUT_DIR, OUTPUT_FILE_NAME)

  if (!fs.existsSync(templatePath)) {
    console.error(
      `Error: Template file ${TEMPLATE_FILE_NAME} not found at: ${templatePath}`
    )
    process.exit(1)
  }

  try {
    const content = fs.readFileSync(templatePath, 'utf8')

    const envNames = []
    const lines = content.split('\n')

    for (const line of lines) {
      const trimmedLine = line.trim()
      if (trimmedLine.length === 0 || trimmedLine.startsWith('#')) {
        continue
      }

      const match = trimmedLine.match(/^([^=]+)=/)
      if (match && match[1]) {
        const key = match[1].trim()
        if (key.length > 0) {
          envNames.push(key)
        }
      }
    }

    if (envNames.length === 0) {
      console.warn(`Warning: No variables found in file ${templatePath}.`)
    }

    let typeDefinition = `export type IEnvironmentVariables = {
`
    let envNamesArray = `export const ENV_NAMES = [
`

    envNames.forEach((name) => {
      typeDefinition += `  ${name}: string
`
      envNamesArray += `  '${name}',
`
    })

    typeDefinition += `}\n`
    envNamesArray += `] as const\n`

    const generatedCode = `// This file was automatically generated by ${path.basename(__filename)} based on ${path.basename(templatePath)}.

${typeDefinition}
${envNamesArray}
`

    if (!fs.existsSync(OUTPUT_DIR)) {
      fs.mkdirSync(OUTPUT_DIR, { recursive: true })
      console.log(`Created directory: ${OUTPUT_DIR}`)
    }

    fs.writeFileSync(OUTPUT_PATH, generatedCode, 'utf8')

    console.log(
      `âœ… Successfully generated environment types in file: ${OUTPUT_PATH}`
    )
    console.log(`Variables found: ${envNames.join(', ')}`)
  } catch (error) {
    console.error(`Error processing files:`, error)
    process.exit(1)
  }
}

generateEnvTypes()
